# React Native Example

A mobile video conferencing app built with React Native CLI and the `@hiyve/rtc-client-rn` SDK. This example demonstrates the core WebRTC client lifecycle on iOS and Android without any `@hiyve/*` UI component packages (React web) - you build the UI yourself with standard React Native components.

## Quick Start

You can either run the root setup script or set up manually:

### Option A: Root Setup Script (Recommended)

From the `hiyve-examples` root directory:

```bash
./setup.sh react-native-example
```

This handles Node.js checks, dependencies, CocoaPods, and environment setup automatically.

### Option B: Manual Setup

#### 1. Install Dependencies

```bash
npm run setup
```

This runs `npm install`, `cd server && npm install`, and `cd ios && bundle install && bundle exec pod install`.

#### 2. Configure Server Credentials

```bash
cp server/.env.example server/.env
```

Edit `server/.env` with your Hiyve credentials:

```env
APIKEY=your-hiyve-api-key
CLIENT_SECRET=your-hiyve-secret
SERVER_REGION=us-west-2
SERVER_REGION_URL=.rtc.muziemedia.com
```

#### 3. Start the App

```bash
npm run dev
```

This starts both the token server (port 3001) and Metro bundler concurrently.

In a separate terminal:

```bash
npm run ios
# or
npm run android
```

## Features

- Create or join video rooms by name
- Real-time video/audio with WebRTC (mediasoup SFU)
- Local video preview with front camera mirror
- Remote participant video grid (auto-layout 1-column or 2-column)
- Mute/unmute microphone
- Enable/disable camera
- Flip between front and back camera
- Leave room with full resource cleanup
- Android runtime permission handling (camera + microphone)
- Platform-aware token server URL (localhost vs 10.0.2.2)
- Dark theme UI

## Packages Used

| Package | Purpose |
|---------|---------|
| `@hiyve/rtc-client-rn` | Core WebRTC client library (mediasoup-client + signaling) |
| `react-native-webrtc` | Native WebRTC implementation (peer dependency) |
| `@react-native-async-storage/async-storage` | Persistent storage (peer dependency) |
| `react-native-safe-area-context` | Safe area insets for notch/island devices |

> **Note:** This example uses `@hiyve/rtc-client-rn` instead of `@hiyve/*` UI component packages. The `@hiyve/*` UI packages provide pre-built React (web) components. For React Native, you build the UI yourself using `RTCView` from `react-native-webrtc` and the `Client` class from `@hiyve/rtc-client-rn`.

## Architecture

```
react-native-example/
├── index.js                    # AppRegistry entry point
├── src/
│   ├── App.tsx                 # Root: state-based routing (idle → connecting → connected)
│   ├── types.ts                # RemoteParticipant, ConnectionState types
│   ├── declarations.d.ts       # TypeScript declarations for @hiyve/rtc-client-rn
│   ├── hooks/
│   │   └── useHiyveClient.ts   # Client lifecycle, events, state management
│   ├── screens/
│   │   ├── JoinScreen.tsx      # Room name + user name form
│   │   └── RoomScreen.tsx      # Video grid + control bar
│   └── components/
│       ├── RemoteVideo.tsx     # Single RTCView for a remote participant
│       └── ControlBar.tsx      # Mic, camera, flip, leave buttons
├── server/
│   ├── server.js               # Express token server
│   ├── package.json            # Server dependencies
│   └── .env.example            # Server config template
├── ios/                        # Xcode project (generated by RN CLI)
└── android/                    # Android project (generated by RN CLI)
```

### Component Flow

```
SafeAreaProvider (App.tsx)
  └── AppContent
      ├── JoinScreen              # connectionState === 'idle' | 'error'
      │   ├── TextInput (room)
      │   ├── TextInput (user)
      │   ├── "Create Room" button
      │   └── "Join Room" button
      ├── ActivityIndicator        # connectionState === 'connecting'
      └── RoomScreen               # connectionState === 'connected'
          ├── Header (room name + participant count)
          ├── RTCView (local video, mirrored)
          ├── FlatList → RemoteVideo (remote participants)
          └── ControlBar
              ├── Mute/Unmute
              ├── Cam On/Off
              ├── Flip Camera
              └── Leave
```

## Code Overview

### useHiyveClient Hook (src/hooks/useHiyveClient.ts)

The core of the example. This custom hook encapsulates the entire `Client` lifecycle:

```tsx
import { Client, ClientEvents } from '@hiyve/rtc-client-rn';

// State managed by the hook:
// - connectionState: 'idle' | 'connecting' | 'connected' | 'error'
// - localStream: MediaStream | null
// - remoteParticipants: Map<string, RemoteParticipant>
// - isAudioMuted, isVideoMuted: boolean
// - error: string | null
// - roomName: string

const {
  connectionState,
  localStream,
  remoteParticipants,
  isAudioMuted,
  isVideoMuted,
  error,
  roomName,
  createRoom,     // (room, userId) => Promise<void>
  joinRoom,       // (room, userId) => Promise<void>
  toggleAudio,    // () => Promise<void>
  toggleVideo,    // () => Promise<void>
  flipCamera,     // () => Promise<void>
  leaveRoom,      // () => Promise<void>
} = useHiyveClient();
```

#### Client Initialization Flow

```tsx
// 1. Request Android permissions (before media access)
const permissionsGranted = await requestAndroidPermissions();

// 2. Fetch room token from local server
const tokenData = await fetch('/api/generate-room-token');

// 3. Construct media server URL from signaling URL
//    '.rtc.muziemedia.com' → '.mediaserver.muziemedia.com'
const mediaServerUrl = tokenData.serverRegionUrl.replace('.rtc.', '.mediaserver.');

// 4. Create client
const client = new Client({
  roomToken: tokenData.roomToken,
  serverRegionUrl: mediaServerUrl,
  regions: [tokenData.serverRegion],
});

// 5. Register event listeners
client.on(ClientEvents.LOCAL_STREAM_READY, ({ stream }) => { ... });
client.on(ClientEvents.CONNECTED, () => { ... });
client.on(ClientEvents.MEDIA_TRACK_ADDED, ({ userId, kind, stream }) => { ... });
// ...

// 6. Create or join room
await client.createRoom({ roomName, userId });  // or client.joinRoom(...)

// 7. Connect media transports (starts producing audio/video)
await client.connectTransports({});
```

#### Event Handling

| Event | Payload | Hook Action |
|-------|---------|-------------|
| `LOCAL_STREAM_READY` | `{ stream: MediaStream }` | Sets `localStream` for RTCView |
| `CONNECTED` | — | Sets `connectionState` to `'connected'` |
| `DISCONNECTED` | — | Resets all state to idle |
| `MEDIA_TRACK_ADDED` | `{ userId, kind, stream }` | Adds stream to `remoteParticipants` map |
| `MEDIA_TRACK_REMOVED` | `{ userId, kind }` | Nulls the stream in participant map |
| `USER_DISCONNECTED` | `{ userId }` | Removes participant from map |
| `ERROR` | `{ error: Error }` | Sets `error` and `connectionState` to `'error'` |
| `AUDIO_MUTED` | `{ muted: string }` | Updates `isAudioMuted` (`'muted'` or `'unmuted'`) |
| `VIDEO_MUTED` | `{ muted: string }` | Updates `isVideoMuted` |

#### Cleanup

The hook handles cleanup in three places:

1. **`leaveRoom()`** — User-initiated: `removeAllListeners()` + `closeConnection()` + reset state
2. **`useEffect` return** — Unmount: `removeAllListeners()` + `closeConnection()`
3. **Error catch blocks** — Failed connection: `cleanupClient()` before setting error state

### Token Server (server/server.js)

Adapted from `basic-example/server/server.js` with one addition: the response includes `serverRegion` and `serverRegionUrl` so the RN client can construct its connection parameters.

```javascript
// POST /api/generate-room-token
// 1. Calls https://<region>.rtc.muziemedia.com/room-token with APIKEY + CLIENT_SECRET
// 2. Returns { roomToken, serverRegion, serverRegionUrl }
```

The token server URL is platform-aware in the hook:
- **iOS Simulator**: `http://localhost:3001`
- **Android Emulator**: `http://10.0.2.2:3001` (maps to host localhost)
- **Physical device**: Must be manually set to your machine's LAN IP

### Rendering Video (RTCView)

React Native WebRTC provides `RTCView` for rendering video streams:

```tsx
import { RTCView } from 'react-native-webrtc';

// Local video (mirrored front camera)
<RTCView
  streamURL={localStream.toURL()}
  objectFit="cover"
  mirror={true}
  style={{ flex: 1 }}
/>

// Remote video
<RTCView
  streamURL={remoteStream.toURL()}
  objectFit="cover"
  style={{ flex: 1 }}
/>
```

Key differences from web `<video>` elements:
- Uses `streamURL` (string from `stream.toURL()`) instead of `srcObject`
- `objectFit` is a prop, not a CSS property
- `mirror` prop for front camera (instead of CSS `transform: scaleX(-1)`)
- Each consumer gets its own `MediaStream` (can't add tracks to existing remote streams)

### Remote Participant State

Remote participants are tracked in a `Map<string, RemoteParticipant>`:

```typescript
interface RemoteParticipant {
  userId: string;
  videoStream: MediaStream | null;  // From MEDIA_TRACK_ADDED (kind: 'video')
  audioStream: MediaStream | null;  // From MEDIA_TRACK_ADDED (kind: 'audio')
}
```

The map is keyed by `userId`. When a `MEDIA_TRACK_ADDED` event fires, the stream is stored. When `MEDIA_TRACK_REMOVED` fires, the stream is nulled. When `USER_DISCONNECTED` fires, the entry is deleted.

## Client API Reference

Methods available on the `Client` instance (from `@hiyve/rtc-client-rn`):

| Method | Signature | Description |
|--------|-----------|-------------|
| `createRoom` | `({ roomName, userId }) => Promise` | Create a new room |
| `joinRoom` | `({ roomName, userId }) => Promise` | Join an existing room |
| `connectTransports` | `({ audioOnly? }) => Promise<void>` | Connect media transports and start producing |
| `muteLocalAudio` | `(mute: boolean) => Promise` | Mute/unmute microphone |
| `muteLocalVideo` | `(mute: boolean) => Promise` | Mute/unmute camera |
| `switchCamera` | `() => Promise<void>` | Switch between front and back camera |
| `closeConnection` | `() => Promise<void>` | Disconnect and clean up all resources |
| `isLocalAudioPaused` | `() => boolean` | Check if audio is muted |
| `isLocalVideoPaused` | `() => boolean` | Check if video is muted |
| `on` | `(event, callback) => void` | Register an event listener |
| `removeAllListeners` | `() => void` | Remove all registered listeners |

See `src/declarations.d.ts` for full TypeScript type definitions.

## Platform Notes

### iOS

- **Permissions**: Camera and microphone usage descriptions are declared in `ios/HiyveExample/Info.plist`
- **Simulator**: WebRTC is supported but camera access is limited. Use a physical device for full testing.
- **CocoaPods**: `react-native-webrtc` requires native pods. Run `cd ios && bundle exec pod install` after `npm install`.
- **Networking**: iOS Simulator can access `localhost` directly (no special URL needed).

### Android

- **Runtime Permissions**: Camera and microphone permissions are requested at runtime in `useHiyveClient` before creating the client. Permissions are also declared in `AndroidManifest.xml`.
- **Emulator Networking**: Android Emulator maps `10.0.2.2` to the host machine's `localhost`. The hook auto-detects this via `Platform.OS`.
- **Min SDK**: React Native 0.83 requires Android SDK 24+.

### Physical Devices

When testing on a physical device, the token server must be reachable over the local network:

1. Find your machine's local IP: `ifconfig | grep "inet " | grep -v 127.0.0.1`
2. Edit `src/hooks/useHiyveClient.ts` and update `TOKEN_SERVER_URL`:
   ```typescript
   const TOKEN_SERVER_URL = 'http://192.168.1.100:3001';
   ```
3. Ensure your firewall allows connections on port 3001.

## Development

### Available Scripts

```bash
npm start              # Start Metro bundler
npm run ios            # Build and run on iOS Simulator
npm run android        # Build and run on Android Emulator
npm run dev:server     # Start token server only (port 3001)
npm run dev            # Start token server + Metro concurrently
npm run setup          # Install all deps + CocoaPods
npm run lint           # Run ESLint
npm test               # Run Jest tests
```

### Developing with Local SDK

Use the toggle-packages script to switch between registry and local packages:

```bash
# Switch to local packages (links to hiyve-sdk)
npm run packages:dev

# Switch back to registry packages
npm run packages:prod

# Check current mode
npm run packages:status
```

Or use the root script to toggle all examples at once:

```bash
./toggle-packages.sh dev    # All examples → local
./toggle-packages.sh prod   # All examples → registry
```

For Metro to resolve the local packages, uncomment the `watchFolders` and `resolver` sections in `metro.config.js`:

```javascript
const config = {
  watchFolders: [path.resolve(__dirname, '../../hiyve-sdk/packages/rtc-client-rn')],
  resolver: {
    nodeModulesPaths: [path.resolve(__dirname, 'node_modules')],
  },
};
```

After switching, reinstall and rebuild:

```bash
npm install
cd ios && bundle exec pod install
```

### Key Differences from Web Examples

| Aspect | Web Examples (`@hiyve/*`) | React Native (`@hiyve/rtc-client-rn`) |
|--------|--------------------------|-----------------------------------|
| UI Components | Pre-built (`VideoGrid`, `ControlBar`, etc.) | Build your own with `RTCView` + RN components |
| State Management | `ClientProvider` context + hooks (`useConnection`, `useRoom`) | Custom `useHiyveClient` hook wrapping `Client` class |
| Video Rendering | `<video>` elements with `srcObject` | `<RTCView>` with `streamURL` |
| Media Streams | Multiple tracks per stream | One `MediaStream` per consumer |
| Camera Switching | Not applicable (web uses device selector) | `client.switchCamera()` (native camera flip) |
| Permissions | Browser prompt | iOS: `Info.plist` declarations; Android: `PermissionsAndroid` runtime API |
| Package Manager | pnpm | npm |
| Bundler | Vite | Metro |

## TypeScript Support

This example includes TypeScript type declarations for `@hiyve/rtc-client-rn` in `src/declarations.d.ts`. These cover the `Client` class, `ClientEvents` constants, and utility functions.

The `@hiyve/rtc-client-rn` package ships its own `.d.ts` files, but the declarations in this example can serve as a reference or override if needed.

## Troubleshooting

### "Server not configured" error

Create `server/.env` with valid Hiyve API credentials. See the Quick Start section.

### "No permission handler detected" (iOS)

CocoaPods are missing. Run:

```bash
cd ios && bundle install && bundle exec pod install
```

### Android build fails with "SDK location not found"

Create `android/local.properties`:

```
sdk.dir=/Users/YOUR_USERNAME/Library/Android/sdk
```

### Camera not working in iOS Simulator

The iOS Simulator has limited camera support. Use a physical iOS device for full WebRTC testing.

### Connection fails on physical device

The token server must be accessible from the device's network. Update `TOKEN_SERVER_URL` in `src/hooks/useHiyveClient.ts` to your machine's LAN IP address (not `localhost`).

### Metro bundler can't resolve `@hiyve/rtc-client-rn`

Run `npm install` to ensure the package is installed. If using local packages (`npm run packages:dev`), verify the `metro.config.js` watchFolders path is correct.

### "Cannot connect to Metro" on Android

Clear the Metro cache and restart:

```bash
npm start -- --reset-cache
```

### App crashes on launch (Android)

Ensure the Android Emulator has enough RAM and that Google Play services are available. WebRTC requires hardware acceleration - use an x86_64 emulator image with hardware acceleration enabled.

## Next Steps

Once you understand this React Native example, check out:

- **basic-example** - Minimal web app using `@hiyve/*` pre-built components
- **full-example** - Feature-rich web app with chat, recording, transcription, whiteboard, Q&A

## Learn More

- [Hiyve SDK Documentation](https://sdk.hiyve.dev)
- [React Native WebRTC](https://github.com/react-native-webrtc/react-native-webrtc)
- [React Native Environment Setup](https://reactnative.dev/docs/set-up-your-environment)
